<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>IdP Task 2 - Attribute Resolving</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>

    <div class="container">

      <img src="hands-on.png" class="pull-right">

      <h1>IdP Task 2 - Attribute Resolving</h1>
      <p>
        In the first task you learnt how to configure the IdP to release attributes. In this second you'll learn how to read the attributes from the data storage, in our case an LDAP server. 
      </p>

      <p>
        Most universities will already have some kind of a data sile where they keep information about their students and staff. The challenge most often is to massage the attributes into a form that is compatible with the schema defined for your federation. This is the job of the attribute resolver. When assissting a member institution to join your federation, this is where you will be having the most effort.
      </p>



      <p>
        You can find detailed information about Attribute Filtering in the Shibboleth Wiki:
        <a href="https://wiki.shibboleth.net/confluence/display/IDP30/AttributeResolverConfiguration">https://wiki.shibboleth.net/confluence/display/IDP30/AttributeResolverConfiguration</a>
      </p>

      <p>
      Don't forget to clear any browser session between every new try.
      </p>



      <h2>Task 2 - Resolve and release the givenName attribute to your SP</h2>

      <p>
        Have a look at <code>roles.idp/templates/attribute-resolver.xml.j2</code>. You will see entries for 4 attributes, one of them the displayName that you released in the first task. And right at the end of file you will see the connector to the data source (LDAP in our case) defined. 
      </p>

      <p>
        The LDAP contains an attribute called <code>givenName</code>. Add an entry into into the resolver for this attribute. For the name you will need the cryptic urn:oid code. You can look that one up in the complete resolver file at <code>/roles/idp/files/attribute-resolver-full.xml</code>.
      </p>
      <p>
        Go the SP (https://192.168.33.88) and click on the "Login via UbuntuNet Alliance (unIDa)" link. Make sure you see the <code>givenName</code> attribute. If you don't see it, you might have forgotten to release it in the attribute-filter.
      </p>



      <h2>Define a static attribute</h2>

      <p>
        Some attributes might be the same for all users, e.g. the homeOrganization which is identical for all members of an university. They are generated by defining a static connector first. You find an example for this in the resolver file. Use it as a template to define an attribute with the id <code>homeOrganization</code> and the URL of your organisation as the value. Choose a suitable id for this connector, eg. <code>staticAttribtues</code>. 
      </p>

      <p>
        Now you need to add the AttributeDefinition for the homeOrganization. The id is <code>urn:oid:1.3.6.1.4.1.25178.1.2.9</code> and the ref value is the id you have chosen above in the connector.
      </p>

      <h2>LDAP properties</h2>      

      <p>
        One last thing to keep in mind is the fact that each new attribute has to be added as one to be returned by the LDAP data connector. This is being done by adding it to the <code>idp.attribute.resolver.LDAP.returnAttributes</code> in the <code>/roles/idp/templates/ldap.properties.j2</code> file.
      </p>

      <p>
        Propagate the attribute <code>schacGender</code> (urn:oid:1.3.6.1.4.1.25178.1.2.2) all the way from the LDAP to be shown in the SP.
        </p>


      <h2>Solution</h2>

      <p>If you can't work out the solution, you can checkout Task 3 and have a look at the attribute-resolver.xml.j2 file</p>
      <code>
        git checkout Task3_Solution<br />
        vi roles/idp/templates/attribute-filter.xml.j2
      </code>

    </div>

  </body>
</html>