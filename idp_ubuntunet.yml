- name: Install Shibboleth IdP v3 for UbuntuNet Alliance
  hosts: idp
  become: True  
  vars:
  roles:
    - role: db
 
  tasks:
    # 1. Systems Requirememts
    - name: Install needed utility programs
      apt: pkg={{ item }} update_cache=yes cache_valid_time=36000
      with_items:
        - ntp
        - unzip

    # 3. Apache HTTP Server installation
    - name: Install apache2
      apt: pkg=apache2 update_cache=yes cache_valid_time=3600

    - name: Copy apache2 config file
      template: >
        src=templates/apache2.conf.j2
        dest=/etc/apache2/sites-available/{{ fully_qualified_service_name }}.conf
      notify: restart apache

    - name: Disable default configuration
      command: a2dissite 000-default
      notify: restart apache

    - name: Enable IdP configuration
      command: a2ensite {{ fully_qualified_service_name }}
      notify: restart apache

    - name: Copy TLS key
      copy: > 
        src=files/{{ fully_qualified_service_name }}.key 
        dest={{ certificate_key_path }}
        owner=root
        group=ssl-cert
        mode=0600
      notify: restart apache

    - name: Copy TLS certificate
      copy: > 
        src=files/{{ fully_qualified_service_name }}.crt 
        dest={{ certificate_cert_path }}
      notify: restart apache

    - name: Enable SSL and AJP Proxy modules
      command: a2enmod ssl proxy_ajp rewrite
      notify: restart apache


    # 4. Java Servlet Container Installation

    # 4.1. Java runtime environment: OpenJDK 7
    # Replace with Oracle Java 
    - name: Install OpenJDK 7
      apt: name=openjdk-7-jdk update_cache=yes cache_valid_time=3600

    # 4.2. Servlet container: Apache Tomcat 7
    - name: Install Tomcat 7
      apt: name=tomcat{{ tomcat_version }} update_cache=yes cache_valid_time=3600

    - name: Copy Tomcat config file
      copy: > 
        src=files/tomcat.xml 
        dest=/etc/tomcat{{ tomcat_version }}/server.xml
      notify: restart tomcat

    - name: Adjust JAVA options
      replace: >
        dest=/etc/default/tomcat{{ tomcat_version }} 
        regexp='JAVA_OPTS="-Djava.awt.headless=true -Xmx128m -XX:\+UseConcMarkSweepGC"' 
        replace='JAVA_OPTS="-server -Xmx1024m -Djava.security.egd=file:/dev/./urandom"'



    # 6. Shibboleth IdP

    # 6.1. IdP installation
    - name: Create download directory
      file: >
        path=/usr/local/dist
        state=directory

    - name: Download Shibboleth IdP
      get_url: > 
        url=https://shibboleth.net/downloads/identity-provider/{{ shibboleth_version }}/shibboleth-identity-provider-{{ shibboleth_version }}.tar.gz
        dest=/usr/local/dist/shibboleth-identity-provider-{{ shibboleth_version }}.tar.gz

    - name: Extract Shibboleth IdP
      unarchive: > 
        src=/usr/local/dist/shibboleth-identity-provider-{{ shibboleth_version }}.tar.gz 
        dest=/usr/local/dist
        copy=no

    - name: Copy customised install script
      template: >
        src=templates/idp-install.sh.j2
        dest=/usr/local/dist/idp-install.sh
        mode=0700


    - name: Install Shibboleth IdP
      command: ./idp-install.sh chdir=/usr/local/dist

    # 6.2. General IdP settings: services.xml and global.xml
    # - name: Adapt MetadataResolverResources in services.xml
    #   replace: >
    #     dest=/opt/shibboleth-idp/conf/services.xml 
    #     regexp='<value>%{idp.home}/conf/metadata-providers.xml</value>' 
    #     replace="<value>#{ '%{idp.metadata}' matches '.*\bswitchaai\b.*' ? '%{idp.home}/conf/metadata-provider-switchaai.xml' : '' }</value>
    #              <value>#{ '%{idp.metadata}' matches '.*\binterfederation\b.*' ? '%{idp.home}/conf/metadata-provider-interfederation.xml' : '' }</value>"

    # - name: Adapt AttributeFilterResources in services.xml
    #   replace: >
    #     dest=/opt/shibboleth-idp/conf/services.xml 
    #     regexp='<value>%{idp.home}/conf/attribute-filter.xml</value>' 
    #     replace='<ref bean="FileBackedSWITCHaaiAttributeFilter"/>'

    #TODO - Insert this part as well
    # <bean id="FileBackedSWITCHaaiAttributeFilter"
    #       class="net.shibboleth.ext.spring.resource.FileBackedHTTPResource"
    #       c:client-ref="#{ '%{idp.http.proxyhost:null}' != 'null' ?
    #                        'shibboleth.ProxyHttpClient' : 'shibboleth.HttpClient' }"
    #       c:url="https://rr.aai.switch.ch/switchaai/example.org/attribute-filter.xml"
    #       c:backingFile="%{idp.home}/conf/attribute-filter.switchaai.xml">
    # </bean>

    # - name: Create attribute-filter.xml
    #   file: >
    #     path=/opt/shibboleth-idp/conf/attribute-filter.ubuntunet.xml 
    #     state=touch
    #     owner=tomcat{{ tomcat_version }}

    - name: Copy global.xml
      copy: > 
        src=files/global.xml
        dest=/opt/shibboleth-idp/conf

    # 6.3. Federation metadata configuration
    # - name: Copy SWITCH metadata providers
    #   copy: > 
    #     src=files/metadata-provider-switchaai.xml 
    #     dest=/opt/shibboleth-idp/conf

    # - name: Copy interfederation metadata providers
    #   copy: > 
    #     src=files/metadata-provider-interfederation.xml 
    #     dest=/opt/shibboleth-idp/conf

    # - name: Copy Trust Anchor Root Certificate
    #   copy: > 
    #     src=files/SWITCHaaiRootCA.crt.pem
    #     dest=/opt/shibboleth-idp/credentials

    - name: Copy IdP properties
      template: >
        src=templates/idp.properties.j2
        dest=/opt/shibboleth-idp/conf/idp.properties

    # - name: Insert Metadata Reference
    #   lineinfile: >
    #     dest=/opt/shibboleth-idp/conf/idp.properties
    #     insertafter=EOF
    #     line="idp.metadata = switchaai, interfederation"

    # - name: Copy UbuntuNet metadata providers
    #   copy: > 
    #     src=files/metadata-provider-ubuntunet.xml 
    #     dest=/opt/shibboleth-idp/conf

    - name: Copy Generic metadata providers
      template: > 
        src=templates/metadata-providers.xml.j2 
        dest=/opt/shibboleth-idp/conf/metadata-providers.xml

    # - name: Copy generic metadata file
    #   template: > 
    #     src=templates/idp-metadata.xml.j2
    #     dest=/opt/shibboleth-idp/metadata/idp-metadata.xml

    - name: Copy static metadata file for an sp
      copy: >
        src=files/sp_dev-metadata.xml 
        dest=/opt/shibboleth-idp/metadata
        owner=tomcat7



    # 6.4. Relying party configuration
    # SWITCH recommends to keep the default IdP v3


    # 6.5. User authentication

    - name: Copy LDAP properties
      template: >
        src=templates/ldap.properties.j2
        dest=/opt/shibboleth-idp/conf/ldap.properties

    - name: Copy LDAP certificate
      copy: >
        src=files/ldap-server.crt 
        dest=/opt/shibboleth-idp/credentials

    - name: Add logger for LDAP authentication
      lineinfile: > 
        dest=/opt/shibboleth-idp/conf/logback.xml
        regexp="org.ldaptive.auth.Authenticator"
        insertbefore="Logs inbound and outbound protocols messages at DEBUG level"
        line='    <logger name="org.ldaptive.auth.Authenticator" level="INFO" />\n'

    # 6.6. Attribute resolution configuration

    - name: Copy Attribute Resolver based on LDAP
      copy: >
        src=files/attribute-resolver-ldap.xml
        dest=/opt/shibboleth-idp/conf/attribute-resolver.xml

    # 6.7. Consent intercept configuration

    - name: Copy Consent agreement configuration
      copy: >
        src=files/consent-intercept-config.xml
        dest=/opt/shibboleth-idp/conf/intercept


    # 6.8. Enabling support for generating persistent IDs

    - name: Copy SAML name properties
      template: >
        src=templates/saml-nameid.properties.j2
        dest=/opt/shibboleth-idp/conf/saml-nameid.properties

    - name: Copy SAML name XML
      copy: >
        src=files/saml-nameid.xml
        dest=/opt/shibboleth-idp/conf

    - name: Copy SAML Subject XML
      copy: >
        src=files/subject-c14n.xml
        dest=/opt/shibboleth-idp/conf/c14n

    # 6.9. Configuring periodic encryption key rotation

    # 6.10. Login form customization

    - name: Copy View/Error Messages properties
      template: >
        src=templates/error-messages.properties.j2
        dest=/opt/shibboleth-idp/messages/error-messages.properties


    - name: Copy logo
      copy: >
        src=files/ualogo.png 
        dest=/opt/shibboleth-idp/webapp/images/


    # 6.11. IdP status URL configuration

    - name: Download IdP Status Page
      copy: >
        src=files/jstl-1.2.jar 
        dest=/opt/shibboleth-idp/edit-webapp/WEB-INF/lib/jstl-1.2.jar
      # get_url: > 
      #   url=https://repo1.maven.org/maven2/jstl/jstl/1.2/jstl-1.2.jar
      #   dest=/opt/shibboleth-idp/edit-webapp/WEB-INF/lib/jstl-1.2.jar

    - name: Enable IdP status URL
      shell: "JAVACMD=/usr/bin/java /opt/shibboleth-idp/bin/build.sh -Didp.target.dir=/opt/shibboleth-idp"
      notify: restart tomcat

    - name: Allow access from host machine
      replace: >
        dest=/opt/shibboleth-idp/conf/access-control.xml
        regexp="{'127.0.0.1/32', '::1/128'}"
        replace="{'127.0.0.1/32', '::1/128', '192.168.33.0/24'}"
      notify: restart tomcat
      

    # 6.12. Hibernate ORM workaround for JPAStorageService

    - name: Create META-INF directory
      file: >
        path=/opt/shibboleth-idp/edit-webapp/WEB-INF/classes/META-INF
        state=directory

    - name: Copy ORM workaround
      copy: > 
        src=files/orm.xml 
        dest=/opt/shibboleth-idp/edit-webapp/WEB-INF/classes/META-INF

    - name: Rebuild id.war
      shell: "JAVACMD=/usr/bin/java /opt/shibboleth-idp/bin/build.sh -Didp.target.dir=/opt/shibboleth-idp"
      notify: restart tomcat


    # 6.13. Web application enablement

    - name: Enable IdP Web application
      copy: > 
        src=files/idp.xml 
        dest=/etc/tomcat7/Catalina/localhost/idp.xml
      notify: restart tomcat


    - name: Copy UFed Metadata File #TODO: Refactor!
      copy: > 
        src=files/uafed-metadata.xml 
        dest=/var/www/html/index.html
      notify: restart apache


  handlers:
    - name: restart apache
      service: name=apache2 state=restarted

    - name: restart tomcat
      service: name=tomcat{{ tomcat_version }} state=restarted

    - name: restart postgres
      service: name=postgresql state=restarted

    # # TODO - Either create a dedicated service or use Tomcat
    # - name: restart shibboleth
    #   service: name=tomcat{{ tomcat_version }} state=restarted
